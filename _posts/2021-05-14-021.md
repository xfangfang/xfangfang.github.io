---
layout: post
title: M1ç‰ˆæœ¬Macbookæœºå™¨å­¦ä¹ ç©¶ç«Ÿæœ‰å¤šå¼º
tags: [keras, mac, ml]
categories: mac
---

å¼€ç¯‡æé†’ï¼šæœ¬æ–‡ç³»æ— æœºäº‘è¯„æµ‹ã€‚

### å‰æƒ…æè¦

ä»Šå¤©åœ¨çŸ¥ä¹ä¸Šçœ‹åˆ°äº† [Apple Silicon M1 æœºå™¨å­¦ä¹ æ€§èƒ½ç®€å•æµ‹è¯•](https://zhuanlan.zhihu.com/p/350955566)ï¼Œçªç„¶æ²¸è…¾äº†ï¼ˆæ²¸è…¾ä½“è­¦å‘Šâš ï¸ï¼‰ã€‚æ–‡ç« ä¸­ç”¨ä¸€æ®µcnnè®­ç»ƒmnistçš„ä»£ç åœ¨å‡ å°æœºå™¨ä¸Šåˆ†åˆ«è¿è¡Œï¼Œä»¥æ¯batchè¿è¡Œæ—¶é—´ä¸ºè¯„æµ‹æ ‡å‡†ï¼Œæ¨ªå‘å¯¹æ¯”ã€‚æ­£å¥½æˆ‘ä¹ŸæŠŠæ‰‹å¤´çš„å‡ ä¸ªç”µè„‘åŠ å…¥è¿™ä¸ªå¯¹æ¯”ä¸­ã€‚

### è¿è¡Œç»“æœ

æŠŠæ–‡ç« ä¸­çš„ç»“æœå’Œæˆ‘è·‘å‡ºæ¥çš„ç»“æœä»¥åŠgithubä¸Šçœ‹åˆ°çš„ç»“æœæ€»ç»“ä¹‹åæ”¾åœ¨ä¸€èµ·ï¼Œæˆ‘æœ€æ„Ÿå…´è¶£çš„æ•°æ®å°±æ˜¯æˆ‘çš„mbpçš„GPUå¯¹æ¯”m1ï¼Œå³ä½¿ä»–æ˜¯ä¸€ä¸ªä¸ååˆ†å‡†ç¡®çš„å¯¹æ¯”ä¹Ÿè®©æˆ‘å¯¹m1æœ‰äº†ä¸ªç²—ç•¥çš„è®¤è¯†ã€‚

|                                                | CPU    | GPU  | TPU  |
| ---------------------------------------------- | ------ | ---- | ---- |
| Macbook Air 2020 M1                            |        | 24s ||
| Macbook Pro 2020 M1       |  | 23s ||
| MacMini 2020 M1   | 16s | 22s ||
| Macbook Pro 13 2015ï¼ˆi5 5257u ?ï¼‰              | 310s ? |      ||
| ğŸ§‘â€ğŸ’» xfangfang's MacBook Air 13 2015ï¼ˆi5 5250uï¼‰ | 85s    |      ||
| ğŸ§‘â€ğŸ’» xfangfang's Macbook Pro 15 2018ï¼ˆi7 8750h; RadeonPro555xï¼‰ | 45s   | 27s ||
| ğŸ§‘â€ğŸ’» xfangfang's PCï¼ˆRyzen5 3600; 2070superï¼‰  | 22s    | 2s   |      |

è¯´çš„æœ‰äº›è¿Ÿåˆ°ï¼Œä½†æ˜¯å¥½åƒARMçš„æ—¶ä»£çœŸçš„æ¥äº†ã€‚æ‰‹ä¸Šè¿™å°18æ¬¾mbpçš„CPUå‘çƒ­å·¨å¤§ï¼Œæ—¥å¸¸ä½¿ç”¨60åº¦ï¼ŒåŠ¨ä¸åŠ¨å°±è·‘åˆ°100åº¦ï¼ŒCPUè·‘è¿™ä¸ªå·ç§¯æ›´æ˜¯é£æ‰‡æ»¡è½¬ï¼Œä¸è¿‡åˆ‡åˆ°GPUå»è¿è¡Œå€’æ˜¯å®Œå…¨ä¸çƒ­ã€‚æ—¥å¸¸çš„é«˜æ¸©è®©æˆ‘çˆ±ä¸èµ·æ¥ï¼Œçœ‹äº†æ•°æ®ç”šè‡³æœ‰ç‚¹æƒ³å…¥æ‰‹ä¸‹ä¸€ä»£ARMå¤„ç†å™¨çš„Macbookã€‚

æ•°æ®ç²—ç²—æµè§ˆä¸‹è½½ï¼Œæœ‰çš„æœºå‹å‰åå·®è·å¾ˆå¤§ï¼Œåº”è¯¥æ˜¯tensorflowæ­£åœ¨å¯¹M1ä¸æ–­ä¼˜åŒ–ï¼ŒARMçœŸçš„æ˜¯æœªæ¥å¯æœŸäº†å•Šã€‚



### é™„ï¼šè¯„æµ‹è„šæœ¬

githubè¯„æµ‹ç»“æœ: https://github.com/apple/tensorflow_macos/issues/25

ä¸ºäº†å¯ä»¥ç”¨mbp18çš„GPUï¼Œç¨å¾®ä¿®æ”¹äº†ä¸€äº›ï¼Œåº”è¯¥å’Œgithubä¸­çš„è„šæœ¬è·‘èµ·æ¥å·®ä¸å¤šã€‚


```python
# è¿è¡Œåœ¨macbookä¸Š ä½¿ç”¨plaidml keraså¼€å¯AMD GPUæ”¯æŒ
# pip install plaidml-keras
# terminal è¿è¡Œ plaidml-setup é€‰æ‹©å¯¹åº”çš„æ˜¾å¡
import plaidml.keras
plaidml.keras.install_backend()
import os
os.environ["KERAS_BACKEND"] = "plaidml.keras.backend"
import keras
```


```python
# é€šç”¨è„šæœ¬ CPU
import os
os.environ['CUDA_VISIBLE_DEVICES'] = '-1'
import tensorflow
keras = tensorflow.keras
```


```python
# é€šç”¨è„šæœ¬ GPU
gpus = tf.config.experimental.list_physical_devices('GPU')
assert len(gpus) > 0, "Not enough GPU hardware devices available"
tf.config.experimental.set_memory_growth(gpus[0], True)
```


ä¸Šé¢ä¸‰æ®µä»£ç ç‰‡æ®µï¼Œåˆ†åˆ«å’Œä¸‹é¢çš„è„šæœ¬ç»„åˆï¼Œç”¨æ¥åœ¨ä¸åŒè®¾å¤‡ä¸Šè¿è¡Œ



```python
import time
import numpy as np
from datetime import timedelta

mnist = keras.datasets.mnist
(train_images, train_labels), (test_images, test_labels) = mnist.load_data()
train_images = np.expand_dims(train_images, axis=3) / 255.0
test_images = np.expand_dims(test_images, axis=3) / 255.0

model = keras.models.Sequential([
    keras.layers.Conv2D(32, kernel_size=(3, 3), activation='relu',input_shape=(28,28,1)),
    keras.layers.Conv2D(64, kernel_size=(3, 3), activation='relu'),
    keras.layers.MaxPooling2D(pool_size=(2, 2)),
    keras.layers.Flatten(),
    keras.layers.Dense(128, activation='relu'),
    keras.layers.Dense(10, activation='softmax')
])
model.compile(
    loss='sparse_categorical_crossentropy',
    optimizer=keras.optimizers.Adam(0.001),
    metrics=['accuracy'],
)
start = time.time()
model.fit(
    train_images,
    train_labels,
    epochs=10,
    batch_size=128
)
delta = (time.time() - start)
elapsed = str(timedelta(seconds=delta))
print('Elapsed Time: {}'.format(elapsed))
```

